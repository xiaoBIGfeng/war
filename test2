import os
import shutil


def parse_txt_file(txt_file, top_k):
    """
    解析单个 txt 文件，提取 Ours most advantageous scenes (all) 中的前 top-k 场景
    """
    with open(txt_file, "r") as f:
        lines = f.readlines()

    # 定位 "Ours most advantageous scenes (all):" 部分
    start_index = None
    for i, line in enumerate(lines):
        if line.strip().startswith("Ours most advantageous scenes (all):"):
            start_index = i + 1
            break

    if start_index is None:
        raise ValueError(f"未找到 'Ours most advantageous scenes (all):' 部分: {txt_file}")

    # 提取前 top-k 的场景
    advantageous_scenes = []
    for line in lines[start_index:]:
        if line.strip() == "":
            break
        parts = line.strip().split(".")  # 格式为 "1. 17_name.png with score 10"
        if len(parts) < 2:
            continue
        rank, rest = parts[0], parts[1]
        name_with_score = rest.split(" with score ")[0].strip()
        index, name = name_with_score.split("_", 1)  # 提取排序号和文件名
        advantageous_scenes.append((int(index), name))

    # 返回前 top-k 的场景
    return advantageous_scenes[:top_k]


def copy_images(parent_folder, txt_files, output_path, top_k):
    """
    根据多个 txt 文件提取前 top-k 的图片，并复制到目标文件夹
    """
    gt_root = os.path.join(parent_folder, "GT")
    method_roots = [
        os.path.join(parent_folder, method)
        for method in os.listdir(parent_folder)
        if method != "GT" and os.path.isdir(os.path.join(parent_folder, method))
    ]

    if not os.path.exists(output_path):
        os.makedirs(output_path)

    for txt_file in txt_files:
        # 获取数据集名称（假设 txt 文件名为 dataset1_psnr_results.txt）
        dataset_name = os.path.basename(txt_file).split("_psnr_results.txt")[0]
        dataset_output_path = os.path.join(output_path, dataset_name)
        if not os.path.exists(dataset_output_path):
            os.makedirs(dataset_output_path)

        # 解析 txt 文件，获取前 top-k 的场景
        top_scenes = parse_txt_file(txt_file, top_k)

        print(f"Processing {dataset_name}, found top {len(top_scenes)} scenes.")

        # 遍历每个场景，复制对应的图片
        for index, name in top_scenes:
            # 源文件路径
            gt_file = os.path.join(gt_root, dataset_name, name)  # GT 图片路径
            if not os.path.exists(gt_file):
                print(f"GT 文件不存在: {gt_file}")
                continue

            # 复制 GT 图片
            gt_target = os.path.join(dataset_output_path, f"{index}_{name}_GT.png")
            shutil.copy(gt_file, gt_target)

            # 遍历方法文件夹，复制对应的方法图片
            for method_root in method_roots:
                method_name = os.path.basename(method_root)  # 提取方法名称
                method_file = os.path.join(method_root, dataset_name, name)  # 方法图片路径
                if not os.path.exists(method_file):
                    print(f"方法文件不存在: {method_file}")
                    continue

                # 复制方法图片
                method_target = os.path.join(dataset_output_path, f"{index}_{name}_{method_name}.png")
                shutil.copy(method_file, method_target)

    print(f"图片提取完成，结果已保存到: {output_path}")


if __name__ == "__main__":
    # 输入参数
    parent_folder = "/path/to/parent_folder"  # 替换为你的 parent_folder 路径
    txt_files = [
        os.path.join(parent_folder, f)
        for f in os.listdir(parent_folder)
        if f.endswith("_psnr_results.txt")
    ]  # 自动获取所有 txt 文件
    output_path = "/path/to/output"  # 输出文件夹路径
    top_k = 5  # 提取前 top-k 的场景

    # 执行图片提取
    copy_images(parent_folder, txt_files, output_path, top_k)
